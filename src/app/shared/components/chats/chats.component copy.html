<div class="px-4">
  <app-image-slider
    *ngIf="showSlider"
    [slides]="sliderSlides"
  ></app-image-slider>
</div>

<div class="flex justify-center mx-auto pb-24 px-4 h-[calc(100svh-60px)]">
  <div
    #chatContainer
    class="w-full h-full overflow-y-auto"
    (scroll)="onScroll()"
  >
    <div class="flex flex-col mx-auto space-y-4 max-w-[720px]">
      <!-- <app-pickleball-booking-card 
              class="shadow rounded-xl max-w-[648px] sm:w-[648px]">
            </app-pickleball-booking-card> -->

      <ng-container *ngFor="let item of groupedMessages; trackBy: trackById">
        <!-- Date Separator -->
        <div
          *ngIf="item.type === 'date'"
          class="sticky-date w-full flex items-center justify-center bg-fade-white"
        >
          <div class="flex items-center w-full px-4">
            <div class="flex-grow border-t border-fade-bg"></div>
            <div
              class="mx-4 text-sm text-gray-500 bg-white px-4 py-1 rounded-full border border-fade-bg whitespace-nowrap"
            >
              {{ item.date | dateFormatter }}
            </div>
            <div class="flex-grow border-t border-fade-bg"></div>
          </div>
        </div>

        <!-- Message Template -->
        <!-- Update message template section -->
        <div
          *ngIf="item.type === 'message'"
          class="flex mb-4"
          [ngClass]="{
            'justify-end': item.data?.sender === 'user',
            'justify-start': item.data?.sender === 'bot'
          }"
        >
          <img
            *ngIf="item.data?.sender === 'bot'"
            [src]="item.data?.avatar"
            class="w-8 h-8 rounded-full mr-2"
            alt="Bot avatar"
          />

          <div class="flex flex-col max-w-[80%]">
            <!-- Text Message -->
            <div *ngIf="item.data?.type === 'text'">
              <div
                *ngFor="let messageItem of item.data?.content"
                [ngClass]="{
                  'bg-[#C3EBF3] rounded-tr-none self-end':
                    item.data?.sender === 'user',
                  'bg-white-00 rounded-tl-none self-start':
                    item.data?.sender === 'bot'
                }"
                class="p-3 shadow whitespace-pre-wrap rounded-xl text-sm mb-2 last:mb-0 inline-block"
              >
                {{ messageItem }}
              </div>
            </div>

            <div
              *ngIf="item.data?.type === 'image'"
              class="flex flex-wrap gap-4"
            >
              <div
                *ngFor="let img of item.data?.content"
                class="shadow rounded-xl overflow-hidden"
              >
                <img
                  [src]="img"
                  class="max-w-[200px] h-auto"
                  alt="Uploaded image"
                />
              </div>
            </div>

            <!-- File/PDF Message -->
            <div
              *ngIf="item.data?.type === 'file'"
              class="p-3 bg-[#C3EBF3] shadow rounded-s-xl rounded-br-xl flex items-center gap-2"
            >
              <div
                class="p-2 border border-mint-400 rounded-md flex items-center space-x-3 px-4"
              >
                <img
                  src="assets/icons/attachment-icon.svg"
                  class="w-6 h-6"
                  alt="PDF icon"
                />
                <a
                  [href]="item.data?.content"
                  target="_blank"
                  class="text-sm flex items-center space-x-3"
                >
                  <div class="space-y-2">
                    <div>{{ item.data?.fileName }}</div>
                    <div>{{ item.data?.fileSize }}</div>
                  </div>
                  <i class="fa-solid fa-download fa-lg"></i>
                </a>
              </div>
            </div>

            <!-- Booking Card -->
            <app-pickleball-booking-card
              *ngIf="item.data?.type === 'booking'"
              class="shadow rounded-xl w-full max-w-[648px] md:w-[648px]"
            >
            </app-pickleball-booking-card>

            <!-- Timestamp -->
            <div
              class="text-xs text-gray-500 mt-3"
              [ngClass]="{
                'text-end': item.data?.sender === 'user',
                'text-start': item.data?.sender === 'bot'
              }"
            >
              {{ item.data?.timestamp | timeAgo }}
            </div>
          </div>

          <img
            *ngIf="item.data?.sender === 'user'"
            src="assets/icons/Avatar.png"
            class="w-8 h-8 rounded-full ml-2"
            alt="User avatar"
          />
        </div>
      </ng-container>
    </div>
  </div>
</div>

<!-- Input container -->
<div
  class="flex flex-col items-center gap-4 fixed lg:sticky bottom-0 w-full bg-fade-white message transition-all duration-700 py-2 lg:py-4 px-4"
>
  <div
    *ngIf="showMessageTemplate"
    class="w-full max-w-[720px] transition-all duration-500"
    [ngClass]="{
      'h-0': !showMessageTemplate,
      'h-full': showMessageTemplate
    }"
  >
    <h2 class="text-lg lg:text-xl font-semibold text-center py-2 lg:py-4">
      How can I assist you today?
    </h2>
    <div class="flex flex-wrap justify-center gap-2">
      <!-- <button (click)="setChatUser('contact-id-1')">Load Bella Cote Chat {{chatId}}</button> -->
      <!-- <button (click)="setChatUser('contact-id-12')">Load Channel Chat</button> -->
      <button
        (click)="sendQuickMessage('Show my upcoming bookings')"
        class="flex items-center gap-2 px-3 py-2 bg-white-00 rounded-xl shadow text-xs lg:text-sm hover:bg-fade-white transition-colors duration-200"
      >
        <img src="assets/icons/calender-icon.svg" />
        Upcoming Bookings
      </button>

      <button
        (click)="sendQuickMessage('Book a pickleball court')"
        class="flex items-center gap-2 px-3 py-2 bg-white-00 rounded-xl shadow text-xs lg:text-sm hover:bg-fade-white transition-colors duration-200"
      >
        <img src="assets/icons/pickle-racket-icon.svg" />
        Pickleball Court
      </button>

      <button
        (click)="sendQuickMessage('Schedule doctor appointment')"
        class="flex items-center gap-2 px-3 py-2 bg-white-00 rounded-xl shadow text-xs lg:text-sm hover:bg-fade-white transition-colors duration-200"
      >
        <img src="assets/icons/square-plus-icon.svg" />
        Doctor Appointment
      </button>

      <button
        (click)="sendQuickMessage('Show payment history')"
        class="flex items-center gap-2 px-3 py-2 bg-white-00 rounded-xl shadow text-xs lg:text-sm hover:bg-fade-white transition-colors duration-200"
      >
        <img src="assets/icons/payment-history-icon.svg" />
        Payment History
      </button>
    </div>
  </div>
  <div class="flex items-center gap-2.5 w-full lg:max-w-[720px] mt-2 lg:mt-4">
    <div
      (click)="toggleMessageTemplate()"
      class="w-[48px] h-full justify-center flex items-center px-2 py-[13px] cursor-pointer shadow rounded-xl border border-fade-white bg-white"
    >
      <app-icon icon="chat" color="#141414"></app-icon>
    </div>
    <div
      class="w-full lg:max-w-[700px] flex items-center rounded-xl bg-white-00 px-4 py-1.5 shadow transition-all duration-300 min-w-0"
      [ngClass]="
        userInput ? 'border-gray-500 border' : 'border-fade-white border'
      "
    >
      <input
        type="text"
        appAutoScrollInput
        [(ngModel)]="userInput"
        placeholder="Type here..."
        class="flex-1 w-full outline-none text-sm px-2 placeholder-custom"
        (keydown.enter)="sendMessage()"
      />
      <div class="flex items-center gap-3 text-fade-text cursor-pointer">
        <img
          src="assets/icons/plus-chat-icon.svg"
          (click)="fileInput.click()"
        />
        <input
          type="file"
          (change)="handleFileUpload($event)"
          hidden
          #fileInput
        />
        <img src="assets/icons/mike-icon.svg" class="py-2" />
        <img src="assets/icons/echo-icon.svg" class="py-2" />
      </div>
      <button
        (click)="sendMessage()"
        class="hidden lg:block ml-2 rounded-xl p-2 transition-colors duration-500 cursor-pointer"
        [ngClass]="{
          'bg-black text-white': userInput,
          'bg-fade-white text-white-00 hover:bg-black': !userInput
        }"
      >
        <img src="assets/icons/send-icon.svg" class="" />
      </button>
    </div>
  </div>
</div>
